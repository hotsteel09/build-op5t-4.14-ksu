name: Build Kernel with KernelSU

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 编译可能耗时较长

    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: ederevx/x-ft_kernel_oneplus_msm8998
        submodules: recursive

    - name: Setup KernelSU v0.9.5
      run: |
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          gcc-aarch64-linux-gnu

    - name: Setup toolchain
      run: |
        # 下载或使用预置的交叉编译工具链
        # 这里使用aarch64-linux-gnu-gcc，可根据实际需要替换
        # 如果内核源码已有工具链配置，可跳过此步
        echo "Toolchain setup completed"

    - name: Configure kernel
      run: |
        # 根据实际内核配置方式执行，这里以defconfig为例
        # 需要根据实际设备调整ARCH和defconfig名称
        make ARCH=arm64 O=out oneplus_msm8998_defconfig

    - name: Build kernel
      run: |
        make ARCH=arm64 O=out -j$(nproc) 2>&1 | tee build.log

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-output
        path: |
          out/arch/arm64/boot/Image.gz-dtb
          build.log
        retention-days: 7

    - name: Check build status
      run: |
        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "Build successful!"
        else
          echo "Build failed!"
          exit 1
        fi
