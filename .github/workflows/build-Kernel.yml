name: Build Kernel with KernelSU (4.14内核)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: ederevx/x-ft_kernel_oneplus_msm8998
        path: kernel

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu

    - name: Setup KernelSU (builtin)
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin

    - name: Apply manual hooks for 4.14 kernel
      run: |
        cd kernel
        
        # 1. 修改 fs/exec.c - 4.14内核的execveat钩子
        # 注意：4.14内核使用do_execveat_common函数，参数签名不同
        cat << 'EOF' >> fs/exec.c
        #ifdef CONFIG_KSU_MANUAL_HOOK
        __attribute__((hot))
        extern int ksu_handle_execveat(int *fd, struct filename **filename_ptr,
                void *argv, void *envp, int *flags);
        #endif
        EOF
        
        # 在do_execveat_common函数中添加调用（4.14内核位置）
        # 注意：4.14内核的do_execveat_common函数签名与4.19+不同
        sed -i '/static int do_execveat_common(int fd, struct filename \*filename,/a\
        #ifdef CONFIG_KSU_MANUAL_HOOK\
        ksu_handle_execveat(&fd, &filename, argv, envp, &flags);\
        #endif' fs/exec.c

        # 2. 修改 fs/stat.c - 4.14内核的stat钩子
        # 4.14内核使用vfs_fstatat函数，不是vfs_statx
        cat << 'EOF' >> fs/stat.c
        #ifdef CONFIG_KSU_MANUAL_HOOK
        __attribute__((hot)) 
        extern int ksu_handle_stat(int *dfd, const char __user **filename_user,
                int *flags);
        #endif
        EOF
        
        # 在vfs_fstatat函数中添加调用（4.14内核）
        sed -i '/int vfs_fstatat(int dfd, const char __user \*filename, struct kstat \*stat,/a\
        #ifdef CONFIG_KSU_MANUAL_HOOK\
        ksu_handle_stat(&dfd, &filename, &flag);\
        #endif' fs/stat.c

        # 3. 修改 kernel/reboot.c - reboot钩子（与4.19+相同）
        cat << 'EOF' >> kernel/reboot.c
        #ifdef CONFIG_KSU_MANUAL_HOOK
        extern int ksu_handle_sys_reboot(int magic1, int magic2, unsigned int cmd, void __user **arg);
        #endif
        EOF
        
        sed -i '/SYSCALL_DEFINE4(reboot, int, magic1, int, magic2, unsigned int, cmd,/a\
        #ifdef CONFIG_KSU_MANUAL_HOOK\
        ksu_handle_sys_reboot(magic1, magic2, cmd, &arg);\
        #endif' kernel/reboot.c
        
        # 4. 修改 fs/open.c - 4.14内核的faccessat钩子
        # 4.14内核使用do_faccessat函数，不是faccessat系统调用
        cat << 'EOF' >> fs/open.c
        #ifdef CONFIG_KSU_MANUAL_HOOK
        __attribute__((hot)) 
        extern int ksu_handle_faccessat(int *dfd, const char __user **filename_user,
                int *mode, int *flags);
        #endif
        EOF
        
        # 在do_faccessat函数中添加调用（4.14内核）
        sed -i '/static long do_faccessat(int dfd, const char __user \*filename, int mode)/a\
        #ifdef CONFIG_KSU_MANUAL_HOOK\
        ksu_handle_faccessat(&dfd, &filename, &mode, NULL);\
        #endif' fs/open.c

        # 5. 额外：4.14内核可能需要vfs_read钩子（如果配置要求）
        # 检查是否需要，根据实际编译错误决定

    - name: Configure kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        if [ -f "arch/arm64/configs/oneplus_msm8998_defconfig" ]; then
          make oneplus_msm8998_defconfig
        else
          make defconfig
        fi
        
        # 启用KernelSU配置
        echo "CONFIG_KSU=y" >> .config
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
        make olddefconfig

    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make -j$(nproc)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-output
        path: kernel/arch/arm64/boot/Image*
        retention-days: 7
