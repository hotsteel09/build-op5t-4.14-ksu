name: Build Kernel with KernelSU

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 编译可能耗时较长

    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: ederevx/x-ft_kernel_oneplus_msm8998
        path: kernel

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          curl \
          wget \
          gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu

    - name: Setup KernelSU (builtin)
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash -s builtin
    
    - name: Apply manual hooks patch
      run: |
        cd kernel
        # 下载并应用补丁
        wget -O manual_hooks.patch https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/patches/manual_hooks.patch
        patch -p1 < manual_hooks.patch || echo "Patch may have conflicts, check manually"
        
        # 如果补丁失败，尝试使用git apply的宽松模式
        git apply --reject --whitespace=fix manual_hooks.patch 2>/dev/null || true
        
        # 检查是否成功应用
        if ! grep -q "CONFIG_KSU_MANUAL_HOOK" .config 2>/dev/null; then
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
        fi
    
    - name: Configure kernel with KernelSU options
      run: |
        cd kernel
        # 确保配置包含KernelSU
        if [ -f "arch/arm64/configs/oneplus_msm8998_defconfig" ]; then
          make oneplus_msm8998_defconfig
        else
          make defconfig
        fi
        echo "CONFIG_KSU=y" >> .config
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> .config
        make olddefconfig


    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        # 启用并行编译加速
        make -j$(nproc)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-output
        path: |
          kernel/arch/arm64/boot/Image.gz-dtb
          kernel/arch/arm64/boot/Image
          kernel/arch/arm64/boot/dts/qcom/*.dtb
        if-no-files-found: error
        retention-days: 7
